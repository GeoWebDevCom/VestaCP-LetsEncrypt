#!/bin/bash
#

# Generate Domain List including all aliases
function GenerateLSDomains () {
        /usr/local/vesta/bin/v-list-web-domains-alias $1 | while read line
        do
                domains="-d $(echo $line | cut -d" " -f1)"
                aliases=$(echo $line | cut -d" " -f2)
                if [ $(echo $line | cut -d" " -f1) == $2 ]; then
                        IFS=',' read -a alias <<< "$aliases"
                        for d in "${alias[@]}"; do
                                domains=$domains" -d "$d
                        done
                        echo $domains
                fi
        done
}

# Generate List from all Let's Encrypt Domains
function GenerateLSList () {
        /usr/local/vesta/bin/v-list-web-domains-ssl-letsencrypt $1 | while read line
        do
                domain=$(echo $line | cut -d" " -f1)
                le=$(echo $line | cut -d" " -f2)
                if [ $le == "yes" ]; then
			echo $domain
                fi
        done
	echo $domains
}

for u in $(/usr/local/vesta/bin/v-list-users | cut -f1 -d' '  | tail -n+3); do
	for d in $(GenerateLSList $u); do
		# Check if Certificate already exist...
		le_base="/etc/letsencrypt/live/$d"
		if [ -f $le_base/fullchain.pem ]; then
        		# ... and is not older then 60 days
        		if ! [ "$(( $(date +"%s") - $(stat -c "%Y" $le_base/fullchain.pem) ))" -lt "5184000" ]; then
                		# Renew Let's Encrypt Certificate
                		/root/letsencrypt/letsencrypt-auto -c /etc/letsencrypt/webroot.ini $(GenerateLSDomains $u $d) certonly
        		fi
		fi
	done
done
